{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-10">
        <h1
            class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-cyan-500 mb-2">
            Add New Faces</h1>
        <p class="text-gray-500">Register individuals manually or automatically via RTSP streams.</p>
    </div>

        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">   

        <!-- Option 1: Single Face Registration -->
        <div
            class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 transition-all hover:shadow-2xl">
            <div class="bg-gradient-to-r from-indigo-50 to-white px-6 py-4 border-b border-gray-100">
                <h2 class="text-xl font-bold text-indigo-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Single Face Registration
                </h2>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-500 mb-4">Register a single user manually by uploading a photo or using
                    your
                    webcam.</p>

                <!-- Input Method Selection -->
                <div class="flex space-x-4 mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="inputMethod" value="upload" id="radioUpload"
                            class="text-indigo-600 focus:ring-indigo-500 h-4 w-4" checked>
                        <span class="ml-2 text-sm font-medium text-gray-700">Upload Image</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="inputMethod" value="webcam" id="radioWebcam"
                            class="text-indigo-600 focus:ring-indigo-500 h-4 w-4">
                        <span class="ml-2 text-sm font-medium text-gray-700">Use Webcam</span>
                    </label>
                </div>

                <!-- Upload Section -->
                <div id="uploadSection" class="mb-5">
                    <div
                        class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl hover:border-indigo-500 transition-colors bg-gray-50">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48" aria-hidden="true">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600 justify-center">
                                <label for="fileUpload"
                                    class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 px-1">
                                    <span>Upload a file</span>
                                    <input id="fileUpload" name="fileUpload" type="file" accept="image/jpeg, image/png"
                                        class="sr-only">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">PNG or JPG up to 5MB</p>
                        </div>
                    </div>
                </div>

                <!-- Webcam Section -->
                <div id="webcamSection" class="hidden mb-5">
                    <div
                        class="relative w-full aspect-video bg-gray-900 rounded-xl overflow-hidden shadow-inner flex flex-col items-center justify-center ring-4 ring-gray-50">
                        <button id="startCameraBtn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md z-30 transition-colors">Start
                            Camera</button>
                        <video id="videoElement" autoplay playsinline
                            class="absolute inset-0 w-full h-full object-cover hidden"></video>
                    </div>

                    <div class="flex gap-2 mt-3">
                        <button id="captureBtn"
                            class="hidden flex-1 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-medium py-2.5 px-4 rounded-lg shadow-md transition-all">
                            Capture Photo
                        </button>
                        <button id="retakeBtn"
                            class="hidden relative flex-1 items-center justify-center rounded-lg border border-gray-300 bg-white py-2.5 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 transition-all">
                            Retake
                        </button>
                    </div>
                </div>

                <!-- Preview Box for both Upload and Webcam -->
                <div id="imagePreviewContainer" class="hidden mb-5">
                    <p class="text-sm font-medium text-gray-700 mb-2">Selected Image:</p>
                    <div
                        class="relative w-full aspect-video bg-gray-100 rounded-xl overflow-hidden shadow-inner flex items-center justify-center border border-gray-200">
                        <img id="capturePreview" class="w-full h-full object-contain" alt="Preview view">
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700">Person's Name</label>
                        <input type="text" id="userName" name="name" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="e.g. John Doe">
                    </div>

                    <button id="registerBtn" disabled
                        class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:from-gray-400 disabled:to-gray-500 transition-all mt-2">
                        Register Face
                    </button>

                    <div id="statusMessage" class="hidden p-3 rounded-lg text-sm text-center font-medium mt-3 border">
                    </div>
                </div>
            </div>
        </div> <!-- End Single Face Registration Block -->

        <!-- Option 2: RTSP Auto Detect -->
        <div
            class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 transition-all hover:shadow-2xl">
            <div class="bg-gradient-to-r from-cyan-50 to-white px-6 py-4 border-b border-gray-100">
                <h2 class="text-xl font-bold text-cyan-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                    RTSP Auto Registry
                </h2>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-500 mb-6 h-10">Provide an IP camera URL. The system will auto-detect
                    unknown faces and assign sequential names (001, 002).</p>

                <div class="space-y-5">
                    <div>
                        <label for="rtspUrl" class="block text-sm font-medium text-gray-700 mb-1">RTSP Stream
                            URL</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">ðŸ”—</span>
                            </div>
                            <input type="text" id="rtspUrl" name="rtspUrl" required
                                class="pl-10 block w-full border border-gray-300 rounded-lg py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
                                placeholder="rtsp://admin:pass@192.168.1.100/stream">
                        </div>
                    </div>

                    <button id="startRtspBtn"
                        class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Start Stream Processing
                    </button>

                    <button id="stopRtspBtn"
                        class="hidden w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        Stop Processing
                    </button>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Start Stream Processing
                    </button>

                    <button id="stopRtspBtn"
                        class="hidden w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        Stop Processing
                    </button>

                    <!-- RTSP Live Stream Preview -->
                    <div id="rtspPreviewContainer" class="hidden mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Live Stream Preview:</p>
                        <div
                            class="relative w-full aspect-video bg-gray-900 rounded-xl overflow-hidden shadow-inner flex items-center justify-center border border-gray-700">
                            <img id="rtspPreview" class="w-full h-full object-contain"
                                alt="Live stream feed will appear here">
                        </div>
                    </div>

                    <div id="rtspStatusMessage"
                        class="hidden p-3 rounded-lg text-sm text-center font-medium mt-3 border"></div>
                </div>
            </div> <!-- End Option 2 Padding block -->
        </div> <!-- End Option 2 Background block -->
    </div> <!-- End Main Container Wrapper -->

    <script>
        // --- Unified Submit Logic ---
        const radioUpload = document.getElementById('radioUpload');
        const radioWebcam = document.getElementById('radioWebcam');
        const uploadSection = document.getElementById('uploadSection');
        const webcamSection = document.getElementById('webcamSection');

        const fileUpload = document.getElementById('fileUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');

        const video = document.getElementById('videoElement');
        const capturePreview = document.getElementById('capturePreview');
        const cameraStatus = document.getElementById('cameraStatus');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const countdown = document.getElementById('countdown');

        const registerBtn = document.getElementById('registerBtn');
        const userNameInput = document.getElementById('userName');
        const statusMessage = document.getElementById('statusMessage');

        let stream = null;
        let finalImageBase64 = null;

        // Toggle sections based on radio
        radioUpload.addEventListener('change', () => {
            if (radioUpload.checked) {
                uploadSection.classList.remove('hidden');
                webcamSection.classList.add('hidden');
                stopCamera();
                checkRegisterState();

                if (fileUpload.files && fileUpload.files[0]) {
                    imagePreviewContainer.classList.remove('hidden');
                } else {
                    imagePreviewContainer.classList.add('hidden');
                }
            }
        });

        radioWebcam.addEventListener('change', () => {
            if (radioWebcam.checked) {
                webcamSection.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                fileUpload.value = ""; // clear file
                finalImageBase64 = null;
                imagePreviewContainer.classList.add('hidden');
                checkRegisterState();
            }
        });

        // --- Upload Logic ---
        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                finalImageBase64 = event.target.result;
                capturePreview.src = finalImageBase64;
                imagePreviewContainer.classList.remove('hidden');
                checkRegisterState();
            };
            reader.readAsDataURL(file);
        });

        // --- Webcam Logic ---
        startCameraBtn.addEventListener('click', async () => {
            startCameraBtn.classList.add('hidden');
            cameraStatus.classList.remove('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                video.classList.remove('hidden');
                cameraStatus.classList.add('hidden');
                captureBtn.classList.remove('hidden');
            } catch (err) {
                cameraStatus.textContent = "Error accessing camera: " + err.message;
                cameraStatus.classList.replace('text-white', 'text-red-500');
                startCameraBtn.classList.remove('hidden');
            }
        });

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.classList.add('hidden');
            captureBtn.classList.add('hidden');
            retakeBtn.classList.add('hidden');
            startCameraBtn.classList.remove('hidden');
            cameraStatus.classList.add('hidden');
            cameraStatus.textContent = "Initializing camera...";
        }

        // Play sound from URL function wrapper
        function playBeep(frequency = 800, duration = 150) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.frequency.value = frequency;
                osc.type = "sine";
                osc.start();
                setTimeout(() => { osc.stop(); ctx.close(); }, duration);
            } catch (e) { console.log("Audio not supported"); }
        }

        captureBtn.addEventListener('click', () => {
            let count = 3;
            countdown.classList.remove('hidden');
            countdown.textContent = count;
            playBeep(600, 100);

            const tick = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                    playBeep(600, 100);
                } else {
                    clearInterval(tick);
                    countdown.classList.add('hidden');
                    takeSnapshot();
                }
            }, 1000);
        });

        function takeSnapshot() {
            playBeep(1200, 300); // Higher pitch for actual snap
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            finalImageBase64 = canvas.toDataURL('image/jpeg', 0.8);

            video.classList.add('hidden');
            capturePreview.src = finalImageBase64;
            imagePreviewContainer.classList.remove('hidden');

            captureBtn.classList.add('hidden');
            retakeBtn.classList.remove('hidden');

            checkRegisterState();
        }

        retakeBtn.addEventListener('click', () => {
            imagePreviewContainer.classList.add('hidden');
            video.classList.remove('hidden');

            captureBtn.classList.remove('hidden');
            retakeBtn.classList.add('hidden');

            finalImageBase64 = null;
            checkRegisterState();
        });

        userNameInput.addEventListener('input', checkRegisterState);

        function checkRegisterState() {
            if (finalImageBase64 && userNameInput.value.trim().length > 0) {
                registerBtn.disabled = false;
            } else {
                registerBtn.disabled = true;
            }
        }

        function showMessage(element, text, isSuccess) {
            element.textContent = text;
            element.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            if (isSuccess === true) {
                element.classList.add('bg-green-100', 'text-green-800');
            } else if (isSuccess === false) {
                element.classList.add('bg-red-100', 'text-red-800');
            } else {
                element.classList.add('bg-blue-100', 'text-blue-800'); // Neutral
            }
        }

        registerBtn.addEventListener('click', async () => {
            registerBtn.disabled = true;
            registerBtn.textContent = "Registering...";
            showMessage(statusMessage, "Processing...", null);

            try {
                const response = await fetch('/webcam/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: userNameInput.value.trim(),
                        image: finalImageBase64
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(statusMessage, data.message, true);
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                        userNameInput.value = "";
                        registerBtn.textContent = "Register Face";
                        registerBtn.disabled = true;
                        if (radioWebcam.checked) {
                            retakeBtn.click();
                        } else {
                            fileUpload.value = "";
                            finalImageBase64 = null;
                            imagePreviewContainer.classList.add('hidden');
                        }
                    }, 2000);
                } else {
                    showMessage(statusMessage, data.detail || "Registration failed.", false);
                    registerBtn.disabled = false;
                    registerBtn.textContent = "Register Face";
                }
            } catch (err) {
                showMessage(statusMessage, "Network error occurred.", false);
                registerBtn.disabled = false;
                registerBtn.textContent = "Register Face";
            }
        });

        // --- RTSP Logic ---
        const rtspUrlInput = document.getElementById('rtspUrl');
        const startRtspBtn = document.getElementById('startRtspBtn');
        const stopRtspBtn = document.getElementById('stopRtspBtn');
        const rtspStatusMessage = document.getElementById('rtspStatusMessage');
        const rtspPreviewContainer = document.getElementById('rtspPreviewContainer');
        const rtspPreview = document.getElementById('rtspPreview');

        startRtspBtn.addEventListener('click', async () => {
            const url = rtspUrlInput.value.trim();
            if (!url) {
                showMessage(rtspStatusMessage, "Please enter a valid RTSP URL.", false);
                return;
            }

            startRtspBtn.disabled = true;
            showMessage(rtspStatusMessage, "Starting auto-registration stream...", null);

            try {
                const response = await fetch('/rtsp/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, mode: "register" })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage(rtspStatusMessage, data.message + " Check the server terminal for updates.", true);
                    startRtspBtn.classList.add('hidden');
                    stopRtspBtn.classList.remove('hidden');
                    rtspUrlInput.disabled = true;

                    // Show Live Preview Feed stream!
                    rtspPreviewContainer.classList.remove('hidden');
                    rtspPreview.src = "/rtsp/feed?url=" + encodeURIComponent(url);
                } else {
                    showMessage(rtspStatusMessage, data.detail || "Failed to start.", false);
                    startRtspBtn.disabled = false;
                }
            } catch (err) {
                showMessage(rtspStatusMessage, "Network error.", false);
                startRtspBtn.disabled = false;
            }
        });

        stopRtspBtn.addEventListener('click', async () => {
            const url = rtspUrlInput.value.trim();
            showMessage(rtspStatusMessage, "Stopping stream...", null);
            stopRtspBtn.disabled = true;

            try {
                const response = await fetch('/rtsp/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, mode: "register" }) // Mode doesn't strictly matter for stopping
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage(rtspStatusMessage, data.message, true);
                    startRtspBtn.classList.remove('hidden');
                    stopRtspBtn.classList.add('hidden');
                    startRtspBtn.disabled = false;
                    rtspUrlInput.disabled = false;

                    // Hide and clear Live Preview Feed
                    rtspPreviewContainer.classList.add('hidden');
                    rtspPreview.src = "";
                } else {
                    showMessage(rtspStatusMessage, data.detail || "Failed to stop.", false);
                    stopRtspBtn.disabled = false;
                }
            } catch (err) {
                showMessage(rtspStatusMessage, "Network error.", false);
                stopRtspBtn.disabled = false;
            }
        });

        // Component mounts, don't start camera by default
    </script>
    {% endblock %}