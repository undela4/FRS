{% extends "base.html" %}

{% block title %}Manage Users - Facial Recognition System{% endblock %}

{% block header %}Registered Users{% endblock %}

{% block content %}
<div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
    <div class="px-6 py-4 border-b border-gray-700 bg-gray-750 flex justify-between items-center flex-wrap gap-4">
        <h2 class="text-xl font-semibold text-white">Database Profiles</h2>

        <div class="flex-1 max-w-sm">
            <input type="text" id="searchInput" placeholder="Search by ID or Name..."
                class="w-full bg-gray-900 border border-gray-600 rounded-md py-1.5 px-3 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </div>

        <span class="bg-blue-900 text-blue-200 py-1 px-3 rounded-full text-sm font-medium">Total: {{ users|length
            }}</span>
    </div>

    {% if users %}
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-700 text-gray-300 text-sm uppercase tracking-wider">
                    <th class="px-6 py-4 font-medium">ID</th>
                    <th class="px-6 py-4 font-medium">Image</th>
                    <th class="px-6 py-4 font-medium">Name</th>
                    <th class="px-6 py-4 font-medium">Registered Date</th>
                    <th class="px-6 py-4 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700 text-sm">
                {% for user in users %}
                <tr class="hover:bg-gray-750 transition-colors duration-150" id="user-row-{{ user.id }}">
                    <td class="px-6 py-4 text-gray-400">#{{ user.id }}</td>
                    <td class="px-6 py-4">
                        <div class="h-10 w-10 rounded-full overflow-hidden border-2 border-gray-600 bg-gray-800">
                            <!-- Show just file name or thumbnail if possible, here using path -->
                            <img src="/users/{{ user.id }}/image" alt="{{ user.name }}"
                                class="h-full w-full object-cover"
                                onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%234B5563\' width=\'24\' height=\'24\'><path d=\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\'/></svg>'">
                        </div>
                    </td>
                    <td class="px-6 py-4 font-medium text-white">{{ user.name }}</td>
                    <td class="px-6 py-4 text-gray-400">{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') if
                        user.created_at else 'N/A' }}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="openEditModal({{ user.id }}, '{{ user.name }}')"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-blue-200 bg-blue-900/50 hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 transition-colors duration-200">
                            Edit
                        </button>
                        <button onclick="deleteUser({{ user.id }}, '{{ user.name }}')"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-red-200 bg-red-900/50 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-red-500 transition-colors duration-200">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-400 border-t border-gray-700">
        <svg class="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
            </path>
        </svg>
        <p class="text-lg font-medium text-white mb-1">No users found</p>
        <p class="mb-4">Get started by registering a new user.</p>
        <a href="/register"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500 transition duration-150 ease-in-out">
            Register User
        </a>
    </div>
    {% endif %}
</div>

<!-- Notification Toast -->
<div id="toast"
    class="fixed bottom-5 right-5 transform translate-y-full opacity-0 transition-all duration-300 flex items-center w-full max-w-xs p-4 rounded-lg shadow text-gray-400 bg-gray-800"
    role="alert">
    <div id="toast-icon-container"
        class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg text-green-200 bg-green-800">
        <svg id="toast-icon-success" class="w-5 h-5 hidden" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z" />
        </svg>
        <svg id="toast-icon-error" class="w-5 h-5 hidden text-red-200 bg-red-800" aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z" />
        </svg>
    </div>
    <div id="toast-message" class="ml-3 text-sm font-normal text-white">Message</div>
    <button type="button" onclick="hideToast()"
        class="ml-auto -mx-1.5 -my-1.5 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 inline-flex items-center justify-center h-8 w-8 text-gray-500 hover:text-white bg-gray-800 hover:bg-gray-700"
        data-dismiss-target="#toast" aria-label="Close">
        <span class="sr-only">Close</span>
        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
        </svg>
    </button>
</div>

<!-- Edit User Modal -->
<div id="editModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeEditModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Edit User Profile</h3>
                        <div class="mt-4 space-y-4">
                            <input type="hidden" id="editUserId">

                            <div>
                                <label for="editName" class="block text-sm font-medium text-gray-700">Display
                                    Name</label>
                                <input type="text" id="editName"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Update Photo
                                    (Optional)</label>
                                <p class="text-xs text-gray-500 mb-2">Upload a new image to completely replace this
                                    user's facial embeddings.</p>
                                <input type="file" id="editImageInput" accept="image/jpeg, image/png"
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <img id="editImagePreview"
                                    class="hidden mt-2 w-32 h-32 object-cover rounded-full border border-gray-300">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitEdit()" id="saveEditBtn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Save Changes
                </button>
                <button type="button" onclick="closeEditModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const iconContainer = document.getElementById('toast-icon-container');
        const successIcon = document.getElementById('toast-icon-success');
        const errorIcon = document.getElementById('toast-icon-error');

        toastMessage.textContent = message;

        if (isSuccess) {
            iconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg text-green-200 bg-green-800';
            successIcon.classList.remove('hidden');
            errorIcon.classList.add('hidden');
        } else {
            iconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg text-red-200 bg-red-800';
            successIcon.classList.add('hidden');
            errorIcon.classList.remove('hidden');
        }

        toast.classList.remove('translate-y-full', 'opacity-0');

        // Auto hide after 3 seconds
        setTimeout(hideToast, 3000);
    }

    function hideToast() {
        const toast = document.getElementById('toast');
        toast.classList.add('translate-y-full', 'opacity-0');
    }

    async function deleteUser(userId, userName) {
        if (!confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/users/${userId}`, {
                method: 'DELETE',
            });

            const data = await response.json();

            if (response.ok) {
                const row = document.getElementById(`user-row-${userId}`);
                if (row) row.remove();
                showToast(`Successfully deleted user: ${userName}`);
            } else {
                showToast(`Error deleting user: ${data.detail}`, false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('A network error occurred while deleting the user.', false);
        }
    }

    // --- Search Logic ---
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keyup', function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr[id^="user-row-"]');

            rows.forEach(row => {
                const idCell = row.cells[0].textContent.toLowerCase();
                const nameCell = row.cells[2].textContent.toLowerCase();
                if (idCell.includes(filter) || nameCell.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // --- Edit Modal Logic ---
    let currentEditBase64 = null;

    document.getElementById('editImageInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            currentEditBase64 = event.target.result;
            const preview = document.getElementById('editImagePreview');
            preview.src = currentEditBase64;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    });

    function openEditModal(userId, userName) {
        document.getElementById('editUserId').value = userId;
        document.getElementById('editName').value = userName;
        document.getElementById('editImageInput').value = '';
        currentEditBase64 = null;
        document.getElementById('editImagePreview').classList.add('hidden');
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    async function submitEdit() {
        const btn = document.getElementById('saveEditBtn');
        btn.disabled = true;
        btn.textContent = "Saving...";

        const userId = document.getElementById('editUserId').value;
        const newName = document.getElementById('editName').value.trim();

        try {
            const response = await fetch(`/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: newName,
                    image: currentEditBase64
                })
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message, true);
                closeEditModal();
                setTimeout(() => window.location.reload(), 1000); // Reload to reflect changes
            } else {
                showToast(data.detail, false);
            }
        } catch (err) {
            console.error(err);
            showToast("Network Error", false);
        } finally {
            btn.disabled = false;
            btn.textContent = "Save Changes";
        }
    }
</script>
{% endblock %}