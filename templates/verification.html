{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-10">
        <h1
            class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-cyan-500 mb-2">
            Verification & Identification</h1>
        <p class="text-gray-500">Continuously track faces via Webcam or match against RTSP streams.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Left Column: Verification Controls -->
        <div class="space-y-8">
            <!-- Option 1: Single Face Verification -->
            <div
                class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 transition-all hover:shadow-2xl">
                <div
                    class="bg-gradient-to-r from-indigo-50 to-white px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-indigo-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                            </path>
                        </svg>
                        Single Face Verification
                    </h2>
                </div>

                <div class="p-6">
                    <p class="text-sm text-gray-500 mb-4 h-10">Verify a single person by uploading their image or
                        capturing a frame from the webcam.</p>

                    <!-- Input Method Selection -->
                    <div class="flex space-x-4 mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="verifyMethod" value="upload" id="verifyRadioUpload"
                                class="text-indigo-600 focus:ring-indigo-500 h-4 w-4" checked>
                            <span class="ml-2 text-sm font-medium text-gray-700">Upload Image</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="verifyMethod" value="webcam" id="verifyRadioWebcam"
                                class="text-indigo-600 focus:ring-indigo-500 h-4 w-4">
                            <span class="ml-2 text-sm font-medium text-gray-700">Use Webcam</span>
                        </label>
                    </div>
                    <!-- Upload Section -->
                    <div id="verifyUploadSection" class="mb-5">
                        <div
                            class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl hover:border-indigo-500 transition-colors bg-gray-50">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                    viewBox="0 0 48 48" aria-hidden="true">
                                    <path
                                        d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600 justify-center">
                                    <label for="verifyFileUpload"
                                        class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none px-1">
                                        <span>Upload a file</span>
                                        <input id="verifyFileUpload" name="fileUpload" type="file"
                                            accept="image/jpeg, image/png" class="sr-only">
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500">PNG or JPG up to 5MB</p>
                            </div>
                        </div>
                    </div>

                    <!-- Webcam Section -->
                    <div id="verifyWebcamSection" class="hidden mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Auto-Track:</span>
                            <!-- Toggle Switch -->
                            <div class="flex items-center bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200">
                                <span id="toggleText" class="mr-3 text-xs font-bold text-gray-400">OFF</span>
                                <button id="autoTrackToggle"
                                    class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none"
                                    role="switch" aria-checked="false">
                                    <span aria-hidden="true"
                                        class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"
                                        id="toggleKnob"></span>
                                </button>
                            </div>
                        </div>

                        <div
                            class="relative w-full aspect-video bg-gray-900 rounded-xl overflow-hidden shadow-inner flex flex-col items-center justify-center ring-4 ring-gray-50">
                            <button id="verifyStartCameraBtn"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md z-30 transition-colors">Start
                                Camera</button>
                            <video id="videoElement" autoplay playsinline
                                class="absolute inset-0 w-full h-full object-cover hidden"></video>
                            <canvas id="overlayCanvas"
                                class="absolute inset-0 w-full h-full object-cover z-10 pointer-events-none hidden"></canvas>

                            <!-- Countdown Overlay for Capture -->
                            <div id="countdown"
                                class="hidden absolute z-20 text-6xl font-black text-white shadow-lg drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">
                            </div>

                            <p id="cameraStatus" class="hidden text-gray-400 z-20 flex flex-col items-center">
                                <svg class="animate-spin h-8 w-8 text-indigo-500 mb-2"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Accessing Camera...
                            </p>
                        </div>

                        <div class="flex gap-2 mt-3 w-full">
                            <button id="captureBtn"
                                class="hidden flex-1 w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-medium py-2.5 px-4 rounded-lg shadow-md transition-all">
                                Capture Photo
                            </button>
                            <button id="retakeBtn"
                                class="hidden relative flex-1 items-center justify-center rounded-lg border border-gray-300 bg-white py-2.5 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 transition-all">
                                Retake
                            </button>
                        </div>
                    </div>

                    <!-- Preview Box for Captured Frame -->
                    <div id="imagePreviewContainer" class="hidden mb-5">
                        <p class="text-sm font-medium text-gray-700 mb-2">Captured Frame:</p>
                        <div
                            class="relative w-full aspect-video bg-gray-100 rounded-xl overflow-hidden shadow-inner flex items-center justify-center border border-gray-200 mb-3">
                            <img id="capturePreview" class="w-full h-full object-contain" alt="Preview view">
                        </div>

                        <button id="verifyCapturedBtn"
                            class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">
                            Verify Captured Frame
                        </button>
                    </div>

                    <!-- Single Upload Result Presentation -->
                    <div id="verifySingleResult" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-start">
                            <img id="verifyResultImage" class="h-20 w-20 rounded-md object-cover mr-4 shadow-sm" src=""
                                alt="Verified Person">
                            <div>
                                <h3 id="verifyResultName" class="text-lg font-bold text-gray-900"></h3>
                                <p id="verifyResultEmotion" class="text-sm text-gray-500"></p>
                                <p id="verifyResultStatus"
                                    class="text-xs font-medium px-2 py-1 rounded inline-block mt-1"></p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Option 2: RTSP Auto Verify -->
            <div
                class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 transition-all hover:shadow-2xl">
                <div class="bg-gradient-to-r from-cyan-50 to-white px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-cyan-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        RTSP Auto-Match
                    </h2>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-500 mb-6 h-10">Provide an RTSP camera stream URL. The system will detect
                        known faces passing by and log them into the Match Logs.</p>

                    <div class="space-y-5">
                        <div>
                            <label for="rtspUrl" class="block text-sm font-medium text-gray-700 mb-1">RTSP Stream
                                URL</label>
                            <div class="relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">ðŸ”—</span>
                                </div>
                                <input type="text" id="rtspUrl" name="rtspUrl"
                                    class="pl-10 block w-full border border-gray-300 rounded-lg py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
                                    placeholder="rtsp://admin:pass@192.168.1.100/stream">
                            </div>
                        </div>

                        <button id="startRtspBtn"
                            class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Start Stream Matching
                        </button>

                        <button id="stopRtspBtn"
                            class="hidden w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                            </svg>
                            Stop Matching
                        </button>

                        <div id="rtspStatusMessage"
                            class="hidden p-3 rounded-lg text-sm text-center font-medium mt-3 border"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Recent Match Logs -->
        <div
            class="bg-white rounded-2xl shadow-xl border border-gray-100 p-0 flex flex-col h-full overflow-hidden sticky top-8">
            <div
                class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                        </path>
                    </svg>
                    Live Match Logs
                </h2>
                <a href="/logs"
                    class="text-sm text-indigo-600 hover:text-indigo-800 font-bold transition-colors bg-indigo-50 px-3 py-1 rounded-full">View
                    All â†’</a>
            </div>

            <div class="overflow-y-auto flex-grow bg-white" style="max-height: 600px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 shadow-sm z-10">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Time</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                User</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Confidence</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Source</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody" class="bg-white divide-y divide-gray-100">
                        <tr>
                            <td colspan="4"
                                class="px-6 py-8 whitespace-nowrap text-sm text-gray-400 text-center font-medium">
                                <svg class="w-12 h-12 mx-auto text-gray-200 mb-3" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Waiting for faces...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Hidden canvas for capturing frame to send to server -->
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    // --- Live Match Logs Polling ---
    async function fetchLogs() {
        try {
            const response = await fetch('/logs/matches');
            const logs = await response.json();
            const tbody = document.getElementById('logsTableBody');

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No structural matches found yet.</td></tr>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleTimeString();

                // Confidence Calculation (Distance to Percentage)
                let confidenceHtml = '';
                if (log.confidence_score !== null) {
                    const accuracy = Math.max(0, (1 - log.confidence_score) * 100).toFixed(1);
                    const color = accuracy > 70 ? 'text-green-600' : 'text-yellow-600';
                    confidenceHtml = `<span class="${color} font-medium">${accuracy}%</span>`;
                } else {
                    confidenceHtml = `<span class="text-gray-400">Unknown</span>`;
                }

                // Name lookup (Since we only return the DB object, we might need a join, 
                // but for simplicity we assume face_service handles it or we'll fake it for the demo if user_id is null)
                const name = log.user_id ? `User #${log.user_id}` : '<span class="text-red-500 font-medium">Unknown</span>';

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs uppercase shadow-sm">
                                    ${log.user_id ? 'U' : '?'}
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-bold text-gray-900">${name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${confidenceHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 uppercase tracking-wider font-semibold">${log.source}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        } catch (err) {
            console.error("Failed to fetch logs", err);
        }
    }

    // Poll logs every 3 seconds
    fetchLogs();
    setInterval(fetchLogs, 3000);

    // --- Verification Logic Variables ---
    const verifyRadioUpload = document.getElementById('verifyRadioUpload');
    const verifyRadioWebcam = document.getElementById('verifyRadioWebcam');
    const verifyUploadSection = document.getElementById('verifyUploadSection');
    const verifyWebcamSection = document.getElementById('verifyWebcamSection');

    const verifyFileUpload = document.getElementById('verifyFileUpload');
    const verifySingleResult = document.getElementById('verifySingleResult');
    const verifyResultImage = document.getElementById('verifyResultImage');
    const verifyResultName = document.getElementById('verifyResultName');
    const verifyResultEmotion = document.getElementById('verifyResultEmotion');
    const verifyResultStatus = document.getElementById('verifyResultStatus');

    const verifyStartCameraBtn = document.getElementById('verifyStartCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const countdown = document.getElementById('countdown');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const capturePreview = document.getElementById('capturePreview');
    const verifyCapturedBtn = document.getElementById('verifyCapturedBtn');

    let finalImageBase64 = null;

    // Toggle Verification Sections
    verifyRadioUpload.addEventListener('change', () => {
        if (verifyRadioUpload.checked) {
            verifyUploadSection.classList.remove('hidden');
            verifyWebcamSection.classList.add('hidden');
            imagePreviewContainer.classList.add('hidden');
            stopCamera();
            if (isAutoTracking) autoTrackToggle.click(); // turn off auto track
        }
    });

    verifyRadioWebcam.addEventListener('change', () => {
        if (verifyRadioWebcam.checked) {
            verifyWebcamSection.classList.remove('hidden');
            verifyUploadSection.classList.add('hidden');
            verifySingleResult.classList.add('hidden');
            verifyFileUpload.value = "";
        }
    });

    // Extract verify logic into function
    async function verifyImageBase64(base64Image) {
        verifyResultImage.src = base64Image;
        verifySingleResult.classList.remove('hidden');
        verifyResultName.textContent = "Verifying...";
        verifyResultEmotion.textContent = "";
        verifyResultStatus.textContent = "";
        verifyResultStatus.className = "text-xs font-medium px-2 py-1 rounded inline-block mt-1 bg-gray-200 text-gray-800";

        try {
            const response = await fetch('/webcam/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image })
            });
            const data = await response.json();

            if (data.status === "success") {
                verifyResultName.textContent = data.user.name;

                let details = [];
                if (data.age && data.age !== "Unknown") details.push(`Age: ${data.age}`);
                if (data.gender && data.gender !== "Unknown") details.push(data.gender);
                if (data.race && data.race !== "Unknown") details.push(data.race);
                if (data.emotion && data.emotion !== "Unknown") details.push(data.emotion);

                verifyResultEmotion.textContent = details.length > 0 ? details.join(' | ') : "Predictions details not enabled";
                verifyResultStatus.textContent = "MATCH";
                verifyResultStatus.className = "text-xs font-medium px-2 py-1 rounded inline-block mt-1 bg-green-100 text-green-800";
                fetchLogs(); // refresh logs immediately
            } else {
                verifyResultName.textContent = "Unknown Face";
                verifyResultEmotion.textContent = "";
                verifyResultStatus.textContent = "NO MATCH";
                verifyResultStatus.className = "text-xs font-medium px-2 py-1 rounded inline-block mt-1 bg-red-100 text-red-800";
            }
        } catch (err) {
            verifyResultName.textContent = "Network error";
        }
    }

    // Upload & Verify Single Image
    verifyFileUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            await verifyImageBase64(event.target.result);
        };
        reader.readAsDataURL(file);
    });

    // Verification Capture Btn
    verifyCapturedBtn.addEventListener('click', async () => {
        if (finalImageBase64) {
            await verifyImageBase64(finalImageBase64);
        }
    });


    // --- Webcam Auto-Track Logic ---
    const video = document.getElementById('videoElement');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const hiddenCanvas = document.getElementById('hiddenCanvas');
    const cameraStatus = document.getElementById('cameraStatus');

    const autoTrackToggle = document.getElementById('autoTrackToggle');
    const toggleKnob = document.getElementById('toggleKnob');
    const toggleText = document.getElementById('toggleText');

    let stream = null;
    let autoTrackInterval = null;
    let isAutoTracking = false;

    verifyStartCameraBtn.addEventListener('click', async () => {
        verifyStartCameraBtn.classList.add('hidden');
        cameraStatus.classList.remove('hidden');
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
            video.classList.remove('hidden');
            overlayCanvas.classList.remove('hidden');
            cameraStatus.classList.add('hidden');
            captureBtn.classList.remove('hidden');
        } catch (err) {
            cameraStatus.textContent = "Error accessing camera: " + err.message;
            cameraStatus.classList.replace('text-gray-400', 'text-red-500');
            verifyStartCameraBtn.classList.remove('hidden');
        }
    });

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        video.classList.add('hidden');
        overlayCanvas.classList.add('hidden');
        verifyStartCameraBtn.classList.remove('hidden');
        captureBtn.classList.add('hidden');
        retakeBtn.classList.add('hidden');
        cameraStatus.classList.add('hidden');
        cameraStatus.textContent = "Accessing Camera...";
        clearOverlay();
    }

    // Play beep sound
    function playBeep(frequency = 800, duration = 150) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            osc.frequency.value = frequency;
            osc.type = "sine";
            osc.start();
            setTimeout(() => { osc.stop(); ctx.close(); }, duration);
        } catch (e) { console.log("Audio not supported"); }
    }

    captureBtn.addEventListener('click', () => {
        let count = 3;
        countdown.classList.remove('hidden');
        countdown.textContent = count;
        playBeep(600, 100);

        if (isAutoTracking) autoTrackToggle.click(); // turn off auto track when capturing

        const tick = setInterval(() => {
            count--;
            if (count > 0) {
                countdown.textContent = count;
                playBeep(600, 100);
            } else {
                clearInterval(tick);
                countdown.classList.add('hidden');
                takeSnapshot();
            }
        }, 1000);
    });

    function takeSnapshot() {
        playBeep(1200, 300); // Higher pitch for actual snap
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        finalImageBase64 = canvas.toDataURL('image/jpeg', 0.8);

        // Hide video parts
        video.classList.add('hidden');
        overlayCanvas.classList.add('hidden');
        captureBtn.classList.add('hidden');

        // Show result
        capturePreview.src = finalImageBase64;
        imagePreviewContainer.classList.remove('hidden');
        retakeBtn.classList.remove('hidden');
    }

    retakeBtn.addEventListener('click', () => {
        imagePreviewContainer.classList.add('hidden');
        verifySingleResult.classList.add('hidden'); // Clear result if retaking

        video.classList.remove('hidden');
        overlayCanvas.classList.remove('hidden');

        captureBtn.classList.remove('hidden');
        retakeBtn.classList.add('hidden');

        finalImageBase64 = null;
    });

    // Sync canvas dimensions to video once video metadata loads
    video.onloadedmetadata = () => {
        hiddenCanvas.width = video.videoWidth;
        hiddenCanvas.height = video.videoHeight;
        overlayCanvas.width = video.videoWidth;
        overlayCanvas.height = video.videoHeight;
    };

    function clearOverlay() {
        const ctx = overlayCanvas.getContext('2d');
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    }

    async function performAutoTrack() {
        if (!isAutoTracking) return;

        // Capture frame from video to hidden canvas
        const hCtx = hiddenCanvas.getContext('2d');
        hCtx.drawImage(video, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
        const base64Image = hiddenCanvas.toDataURL('image/jpeg', 0.8);

        try {
            const response = await fetch('/webcam/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image })
            });
            const data = await response.json();

            // Clear previous drawings
            clearOverlay();
            const ctx = overlayCanvas.getContext('2d');

            // Draw bounding box if facial_area exists
            if (data.facial_area && Object.keys(data.facial_area).length > 0) {
                const { x, y, w, h } = data.facial_area;

                // Set styles based on match status
                let isMatch = data.status === "success";
                ctx.strokeStyle = isMatch ? "#10B981" : "#EF4444"; // Green for match, Red for unknown
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, w, h);

                // Prepare label text
                let labelText = isMatch ? data.user.name : "Unknown";

                let pDetails = [];
                if (data.age && data.age !== "Unknown") pDetails.push(`Age ${data.age}`);
                if (data.gender && data.gender !== "Unknown") pDetails.push(data.gender);
                if (data.emotion && data.emotion !== "Unknown") pDetails.push(data.emotion);

                let extraText = pDetails.length > 0 ? ` - ${pDetails.join(', ')}` : "";
                let fullLabel = labelText + extraText;

                // Draw label background
                ctx.fillStyle = isMatch ? "#10B981" : "#EF4444";
                ctx.font = "16px Inter, sans-serif";
                const textWidth = ctx.measureText(fullLabel).width;
                ctx.fillRect(x, y - 25, textWidth + 10, 25);

                // Draw label text
                ctx.fillStyle = "#FFFFFF";
                ctx.fillText(fullLabel, x + 5, y - 7);
            }
        } catch (err) {
            console.error("Auto-track request failed:", err);
        }
    }

    // Toggle logic
    autoTrackToggle.addEventListener('click', () => {
        if (!stream) {
            alert("Please start the camera first!");
            return;
        }

        isAutoTracking = !isAutoTracking;

        if (isAutoTracking) {
            // Turn ON
            autoTrackToggle.classList.replace('bg-gray-200', 'bg-indigo-600');
            toggleKnob.classList.replace('translate-x-0', 'translate-x-5');
            toggleText.textContent = "ON";
            toggleText.classList.replace('text-gray-400', 'text-indigo-600');

            // Start polling loop every 1.5 seconds
            autoTrackInterval = setInterval(performAutoTrack, 1500);
        } else {
            // Turn OFF
            autoTrackToggle.classList.replace('bg-indigo-600', 'bg-gray-200');
            toggleKnob.classList.replace('translate-x-5', 'translate-x-0');
            toggleText.textContent = "OFF";
            toggleText.classList.replace('text-indigo-600', 'text-gray-400');

            // Stop loop and clear canvas
            if (autoTrackInterval) clearInterval(autoTrackInterval);
            clearOverlay();
        }
    });

    // --- RTSP Logic ---
    const rtspUrlInput = document.getElementById('rtspUrl');
    const startRtspBtn = document.getElementById('startRtspBtn');
    const stopRtspBtn = document.getElementById('stopRtspBtn');
    const rtspStatusMessage = document.getElementById('rtspStatusMessage');

    function showMessage(element, text, isSuccess) {
        element.textContent = text;
        element.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
        if (isSuccess === true) {
            element.classList.add('bg-green-100', 'text-green-800');
        } else if (isSuccess === false) {
            element.classList.add('bg-red-100', 'text-red-800');
        } else {
            element.classList.add('bg-blue-100', 'text-blue-800'); // Neutral
        }
    }

    startRtspBtn.addEventListener('click', async () => {
        const url = rtspUrlInput.value.trim();
        if (!url) {
            showMessage(rtspStatusMessage, "Please enter a valid RTSP URL.", false);
            return;
        }

        startRtspBtn.disabled = true;
        showMessage(rtspStatusMessage, "Starting auto-verification stream...", null);

        try {
            const response = await fetch('/rtsp/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url, mode: "verify" })
            });

            const data = await response.json();
            if (response.ok) {
                showMessage(rtspStatusMessage, data.message + " Matches will appear in the log table.", true);
                startRtspBtn.classList.add('hidden');
                stopRtspBtn.classList.remove('hidden');
                rtspUrlInput.disabled = true;
            } else {
                showMessage(rtspStatusMessage, data.detail || "Failed to start.", false);
                startRtspBtn.disabled = false;
            }
        } catch (err) {
            showMessage(rtspStatusMessage, "Network error.", false);
            startRtspBtn.disabled = false;
        }
    });

    stopRtspBtn.addEventListener('click', async () => {
        const url = rtspUrlInput.value.trim();
        showMessage(rtspStatusMessage, "Stopping stream...", null);
        stopRtspBtn.disabled = true;

        try {
            const response = await fetch('/rtsp/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();
            if (response.ok) {
                showMessage(rtspStatusMessage, data.message, true);
                startRtspBtn.classList.remove('hidden');
                stopRtspBtn.classList.add('hidden');
                startRtspBtn.disabled = false;
                rtspUrlInput.disabled = false;
            } else {
                showMessage(rtspStatusMessage, data.detail || "Failed to stop.", false);
                stopRtspBtn.disabled = false;
            }
        } catch (err) {
            showMessage(rtspStatusMessage, "Network error.", false);
            stopRtspBtn.disabled = false;
        }
    });

    // Component mounts, don't start camera by default
</script>
{% endblock %}